---
export async function getStaticPaths() {
	return [{ params: { lang: 'en' } }, { params: { lang: 'es' } }];
}

import Layout from '../../layouts/Layout.astro';
import { useTranslations } from '../../i18n/utils';

// Import new redesigned components
import FeaturedPosts from '../../components/blog/FeaturedPosts.astro';
import AllPosts from '../../components/blog/AllPosts.astro';

// Import blog data
import { getAllPosts } from '../../data/blogPosts';
import { getAllPostsEs } from '../../data/blogPosts-es';
import type { BlogPost } from '../../types/blog';

const { lang } = Astro.params || { lang: 'en' };

if (lang && typeof lang === 'string' && !['en', 'es'].includes(lang)) {
	return new Response(null, {
		status: 404,
		statusText: 'Not Found',
	});
}

const t = useTranslations(lang as 'en' | 'es');

// Get static posts (existing) - cast to BlogPost[] as they might slightly differ but are compatible
const staticPosts: BlogPost[] = (lang === 'en'
	? getAllPosts()
	: getAllPostsEs()) as unknown as BlogPost[];

// Get StudioCMS blog posts - dynamic import to handle conditional availability
let studiocmsPosts: BlogPost[] = [];
let runSDK, SDKCoreJs;
try {
	({ runSDK, SDKCoreJs } = await import('studiocms:sdk'));
	const allPages = await runSDK(SDKCoreJs.GET.pages());
	studiocmsPosts = allPages
		.map(({ data }: { data: any }) => data)
		.filter(({ package: pkg }: { package: string }) => pkg === '@studiocms/blog')
		.map(
			(page: any): BlogPost => ({
				slug: page.slug,
				title: page.title || '',
				excerpt: page.excerpt || '',
				date: page.publishedAt
					? new Date(page.publishedAt)
							.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})
							.toUpperCase()
					: '',
				publishedAt: page.publishedAt ? new Date(page.publishedAt) : new Date(0),
				category: page.category || 'BLOG',
				image: page.image || '',
				imageAlt: page.imageAlt || page.title || '',
				content: page.content || '',
				author: {
					name: page.author?.name || 'Trailmerge Team',
					image: page.author?.image || '/images/default-author.png',
					bio: page.author?.bio || '',
				},
				fromStudioCMS: true,
			})
		);
} catch (error) {
	console.warn('StudioCMS posts not available:', error);
}

// Combine posts: StudioCMS posts first, then static posts
// Sort all posts by date (most recent first)
// Helper to parse dates including Spanish format
const parseDate = (dateStr: string) => {
	if (!dateStr) return new Date(0);

	// Spanish format: D DE MMMM, YYYY (e.g. 8 DE JULIO, 2022)
	const esMonths: Record<string, string> = {
		ENERO: '01',
		FEBRERO: '02',
		MARZO: '03',
		ABRIL: '04',
		MAYO: '05',
		JUNIO: '06',
		JULIO: '07',
		AGOSTO: '08',
		SEPTIEMBRE: '09',
		OCTUBRE: '10',
		NOVIEMBRE: '11',
		DICIEMBRE: '12',
	};

	const esRegex = /(\d+)\s+DE\s+(\w+),\s+(\d+)/i;
	const match = dateStr.match(esRegex);

	if (match) {
		const [, day, month, year] = match;
		const monthNum = esMonths[month.toUpperCase()];
		if (monthNum) {
			return new Date(`${year}-${monthNum}-${day}`);
		}
	}

	// English format fallback / Standard Date parsing
	const enRegex = /(\w+)\s+(\d+),\s+(\d+)/;
	if (enRegex.test(dateStr)) {
		return new Date(dateStr.replace(enRegex, '$2 $1 $3'));
	}

	return new Date(dateStr);
};

const blogPosts: BlogPost[] = [...studiocmsPosts, ...staticPosts].sort((a, b) => {
	const dateA = a.publishedAt || parseDate(a.date);
	const dateB = b.publishedAt || parseDate(b.date);

	const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
	const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime();

	return timeB - timeA; // Most recent first
});
---

<Layout
	title={t('blog.title')}
	description={t('blog.description')}
	lang={lang}
	schemaType="website"
>
	<img src="/images/new/blog/Vector Blob.svg" alt="" class="blog-bg-decoration" loading="eager" />
	<img
		src="/images/new/blog/Vector Blob (1).svg"
		alt=""
		class="blog-blob-top-right"
		loading="eager"
	/>
	<img src="/images/new/blog/Vector Blob (2).svg" alt="" class="blog-blob-left" loading="eager" />
	<FeaturedPosts lang={lang} posts={blogPosts} />
	<AllPosts lang={lang} posts={blogPosts} />
</Layout>

<style>
	.blog-bg-decoration {
		position: absolute;
		top: 250px;
		left: -1598.6px;
		width: 3127.23px;
		height: 3770.66px;
		transform: rotate(190deg);
		opacity: 0.64;
		z-index: -1;
		pointer-events: none;
	}

	.blog-blob-left {
		position: absolute;
		top: 154px;
		left: 0;
		width: auto;
		height: auto;
		z-index: -1;
		pointer-events: none;
	}

	.blog-blob-top-right {
		position: absolute;
		top: 0;
		right: 0;
		width: auto;
		height: auto;
		z-index: -1;
		pointer-events: none;
	}
</style>
