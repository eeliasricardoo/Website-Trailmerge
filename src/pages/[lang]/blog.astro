---
export const prerender = false;

export async function getStaticPaths() {
	return [
		{ params: { lang: 'en' } },
		{ params: { lang: 'es' } },
	];
}

import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import ContactModal from '../../components/ContactModal.astro';
import { getAllPosts } from '../../data/blogPosts';
import { getAllPostsEs } from '../../data/blogPosts-es';
import { useTranslations } from '../../i18n/utils';

// SSR mode - no getStaticPaths needed
const { lang } = Astro.params || { lang: 'en' };
const t = useTranslations(lang as 'en' | 'es');

// Get static posts (existing)
const staticPosts = lang === 'en' ? getAllPosts() : getAllPostsEs();

// Get StudioCMS blog posts
let studiocmsPosts: any[] = [];
try {
	// Dynamic import to handle case where studiocms:sdk is not available
	const { runSDK, SDKCoreJs } = await import('studiocms:sdk');
	const allPages = await runSDK(SDKCoreJs.GET.pages());
	studiocmsPosts = allPages
		.map(({ data }) => data)
		.filter(({ package: pkg }) => pkg === '@studiocms/blog')
		.map((page) => ({
			slug: page.slug,
			title: page.title || '',
			excerpt: page.excerpt || '',
			date: page.publishedAt
				? new Date(page.publishedAt)
						.toLocaleDateString('en-US', {
							year: 'numeric',
							month: 'long',
							day: 'numeric',
						})
						.toUpperCase()
				: '',
			publishedAt: page.publishedAt ? new Date(page.publishedAt) : new Date(0), // Keep original date for sorting
			category: page.category || 'BLOG',
			image: page.image || '',
			imageAlt: page.imageAlt || page.title || '',
			content: page.content || '',
			author: {
				name: page.author?.name || 'Trailmerge Team',
				image: page.author?.image || '/images/default-author.png',
				bio: page.author?.bio || '',
			},
			fromStudioCMS: true,
		}));
} catch (error) {
	console.warn('StudioCMS posts not available:', error);
}

// Combine posts: StudioCMS posts first, then static posts
// Sort all posts by date (most recent first)
const blogPosts = [...studiocmsPosts, ...staticPosts].sort((a, b) => {
	// Use publishedAt for StudioCMS posts, or parse date string for static posts
	const dateA =
		a.publishedAt ||
		(a.date ? new Date(a.date.replace(/(\w+)\s+(\d+),\s+(\d+)/, '$2 $1 $3')) : new Date(0));
	const dateB =
		b.publishedAt ||
		(b.date ? new Date(b.date.replace(/(\w+)\s+(\d+),\s+(\d+)/, '$2 $1 $3')) : new Date(0));
	return dateB.getTime() - dateA.getTime(); // Most recent first
});

// SEO keywords and breadcrumbs
const keywords = t('blog.seo.keywords');
const breadcrumbs = [
	{
		name: t('blog.breadcrumbs.home'),
		url: `https://trailmerge.com/${lang}/`,
	},
	{
		name: t('blog.breadcrumbs.blog'),
		url: `https://trailmerge.com/${lang}/blog/`,
	},
];
---

<Layout
	title={t('blog.title')}
	description={t('blog.description')}
	keywords={keywords}
	breadcrumbs={breadcrumbs}
	lang={lang}
>
	<Navbar lang={lang} />

	<main id="main-content">
		<!-- Blog Posts Section -->
		<div class="blog-page-wrapper">
			<div class="content-container">
				<div class="blog-posts-list">
					{
						blogPosts.map((post) => (
							<article class="blog-post-item">
								<div class="blog-post-thumbnail">
									<a href={`/${lang}/blog/${post.slug}/`} class="blog-thumbnail-link">
										<img
											src={post.image}
											alt={post.imageAlt}
											class="blog-post-image"
											loading="lazy"
										/>
									</a>
								</div>
								<div class="blog-post-content">
									<a href={`/${lang}/blog/${post.slug}/`} class="blog-post-title-link">
										<h2 class="blog-post-title">{post.title}</h2>
									</a>
									<div class="spacer-s" />
									<div class="blog-post-meta">
										<span class="blog-post-date">{post.date}</span>
										<span class="blog-meta-divider"> | </span>
										<span class="blog-post-category">{post.category}</span>
									</div>
									<div class="spacer-s" />
									<div class="blog-post-divider" />
									<div class="spacer-s" />
									<p class="blog-post-excerpt">{post.excerpt}</p>
									<div class="spacer-s" />
									<a href={`/${lang}/blog/${post.slug}/`} class="blog-read-more">
										{t('blog.readMore')}
									</a>
								</div>
							</article>
						))
					}
				</div>
			</div>
		</div>
	</main>

	<Footer lang={lang} />

	<ContactModal lang={lang} />
</Layout>

<style>
	.blog-page-wrapper {
		background-color: var(--off-white);
		padding-top: 120px;
		padding-bottom: 80px;
		min-height: 100vh;
		font-family: Roboto, sans-serif;
	}

	.blog-posts-list {
		display: flex;
		flex-direction: column;
		gap: 48px;
		max-width: 1000px;
		margin: 0 auto;
	}

	.blog-post-item {
		display: flex;
		gap: 32px;
		align-items: flex-start;
		background-color: var(--white);
		border-radius: 8px;
		padding: 24px;
		transition: box-shadow 0.3s ease;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	}

	.blog-post-item:hover {
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
	}

	.blog-post-thumbnail {
		flex: 0 0 256px;
		width: 256px;
	}

	.blog-thumbnail-link {
		display: block;
		overflow: hidden;
		border-radius: 4px;
	}

	.blog-post-image {
		width: 100%;
		height: 180px;
		object-fit: cover;
		border-radius: 4px;
		transition: transform 0.3s ease;
		display: block;
	}

	.blog-thumbnail-link:hover .blog-post-image {
		transform: scale(1.05);
	}

	.blog-post-content {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.blog-post-title-link {
		text-decoration: none;
		transition: opacity 0.2s ease;
	}

	.blog-post-title-link:hover {
		opacity: 0.7;
	}

	.blog-post-title {
		color: var(--grey-5);
		font-size: 28px;
		font-weight: 700;
		line-height: 1.3;
		margin: 0;
		font-family: Bitter, serif;
	}

	.blog-post-meta {
		display: flex;
		align-items: center;
		gap: 8px;
		font-size: 12px;
		font-weight: 600;
		letter-spacing: 0.5px;
		color: var(--grey-3);
		font-family: Roboto, sans-serif;
	}

	.blog-post-date,
	.blog-post-category {
		color: var(--grey-3);
	}

	.blog-meta-divider {
		color: var(--grey-3);
	}

	.blog-post-divider {
		width: 100%;
		height: 1px;
		background-color: var(--grey-1);
	}

	.blog-post-excerpt {
		color: var(--grey-4);
		font-size: 16px;
		line-height: 1.6;
		margin: 0;
		flex: 1;
		font-family: Roboto, sans-serif;
	}

	.blog-read-more {
		color: var(--grey-5);
		font-weight: 700;
		font-size: 16px;
		text-decoration: underline;
		transition: opacity 0.2s ease;
		display: inline-block;
		font-family: Roboto, sans-serif;
	}

	.blog-read-more:hover {
		opacity: 0.7;
		text-decoration: underline;
	}

	/* Responsive Design */
	@media (max-width: 1024px) {
		.blog-page-wrapper {
			padding-top: 100px;
			padding-bottom: 60px;
		}

		.blog-posts-list {
			gap: 40px;
		}
	}

	@media (max-width: 768px) {
		.blog-page-wrapper {
			padding-top: 80px;
			padding-bottom: 48px;
		}

		.blog-posts-list {
			gap: 32px;
		}

		.blog-post-item {
			flex-direction: column;
			gap: 20px;
			padding: 20px;
		}

		.blog-post-thumbnail {
			flex: 0 0 auto;
			width: 100%;
		}

		.blog-post-image {
			height: 240px;
		}

		.blog-post-title {
			font-size: 24px;
		}
	}

	@media (max-width: 480px) {
		.blog-page-wrapper {
			padding-top: 72px;
			padding-bottom: 40px;
		}

		.blog-posts-list {
			gap: 24px;
		}

		.blog-post-item {
			padding: 16px;
			gap: 16px;
		}

		.blog-post-image {
			height: 200px;
		}

		.blog-post-title {
			font-size: 20px;
		}

		.blog-post-excerpt {
			font-size: 14px;
		}
	}
</style>
