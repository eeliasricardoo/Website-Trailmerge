---
export async function getStaticPaths() {
	return [{ params: { lang: 'en' } }, { params: { lang: 'es' } }];
}

import Layout from '../../layouts/Layout.astro';
import { useTranslations } from '../../i18n/utils';

// Import new redesigned components
import FeaturedPosts from '../../components/blog/FeaturedPosts.astro';
import AllPosts from '../../components/blog/AllPosts.astro';

// Import blog data
import { getAllPosts } from '../../data/blogPosts';
import { getAllPostsEs } from '../../data/blogPosts-es';
import type { BlogPost } from '../../types/blog';

const { lang } = Astro.params || { lang: 'en' };

if (lang && typeof lang === 'string' && !['en', 'es'].includes(lang)) {
	return new Response(null, {
		status: 404,
		statusText: 'Not Found',
	});
}

const t = useTranslations(lang as 'en' | 'es');

// Get static posts (existing) - cast to BlogPost[] as they might slightly differ but are compatible
const staticPosts: BlogPost[] = (lang === 'en'
	? getAllPosts()
	: getAllPostsEs()) as unknown as BlogPost[];

// Get StudioCMS blog posts - dynamic import to handle conditional availability
let studiocmsPosts: BlogPost[] = [];
let runSDK, SDKCoreJs;
try {
	({ runSDK, SDKCoreJs } = await import('studiocms:sdk'));
	const allPages = await runSDK(SDKCoreJs.GET.pages());
	studiocmsPosts = allPages
		.map(({ data }: { data: any }) => data)
		.filter(({ package: pkg }: { package: string }) => pkg === '@studiocms/blog')
		.map(
			(page: any): BlogPost => ({
				slug: page.slug,
				title: page.title || '',
				excerpt: page.excerpt || '',
				date: page.publishedAt
					? new Date(page.publishedAt)
							.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})
							.toUpperCase()
					: '',
				publishedAt: page.publishedAt ? new Date(page.publishedAt) : new Date(0),
				category: page.category || 'BLOG',
				image: page.image || '',
				imageAlt: page.imageAlt || page.title || '',
				content: page.content || '',
				author: {
					name: page.author?.name || 'Trailmerge Team',
					image: page.author?.image || '/images/default-author.png',
					bio: page.author?.bio || '',
				},
				fromStudioCMS: true,
			})
		);
} catch (error) {
	console.warn('StudioCMS posts not available:', error);
}

// Combine posts: StudioCMS posts first, then static posts
// Sort all posts by date (most recent first)
const blogPosts: BlogPost[] = [...studiocmsPosts, ...staticPosts].sort((a, b) => {
	const dateA =
		a.publishedAt ||
		(a.date ? new Date(a.date.replace(/(\w+)\s+(\d+),\s+(\d+)/, '$2 $1 $3')) : new Date(0));
	const dateB =
		b.publishedAt ||
		(b.date ? new Date(b.date.replace(/(\w+)\s+(\d+),\s+(\d+)/, '$2 $1 $3')) : new Date(0));
	return dateB.getTime() - dateA.getTime(); // Most recent first
});
---

<Layout
	title={t('blog.seo.title')}
	description={t('blog.seo.description')}
	lang={lang}
	schemaType="website"
>
	<FeaturedPosts lang={lang} posts={blogPosts} />
	<AllPosts lang={lang} posts={blogPosts} />
</Layout>

<style is:global>
	/* Override global background for Blog page */
	body,
	html {
		background: url('/images/new/blog/Blog.svg') repeat-y center top fixed !important;
		background-size: 100% auto !important;
		background-color: var(--off-white) !important; /* Fallback color */
		min-height: 100% !important;
	}
</style>
