---
// SSR mode - fetch post dynamically

import { getAllPosts } from '../../../data/blogPosts';
import { getAllPostsEs } from '../../../data/blogPosts-es';

export async function getStaticPaths() {
	const enPosts = getAllPosts();
	const esPosts = getAllPostsEs();

	const paths: { params: { lang: string; slug: string } }[] = [];
	enPosts.forEach((post) => paths.push({ params: { lang: 'en', slug: post.slug } }));
	esPosts.forEach((post) => paths.push({ params: { lang: 'es', slug: post.slug } }));

	// Fetch dynamic posts from StudioCMS - OPTIONAL/SKIPPED since we are in SSR mode
	// and dynamic import here causes build issues.

	return paths;
}

import { marked } from 'marked';
import Layout from '../../../layouts/Layout.astro';
import { useTranslations } from '../../../i18n/utils';
import { safeCreateURL } from '../../../utils/urlHelpers';

// Import new redesigned components
import PostHero from '../../../components/blog/PostHero.astro';
import PostHeader from '../../../components/blog/PostHeader.astro';
import PostContent from '../../../components/blog/PostContent.astro';
import PostAuthor from '../../../components/blog/PostAuthor.astro';

import type { BlogPost } from '../../../types/blog';

const { lang, slug } = Astro.params || { lang: 'en', slug: '' };
const translator = useTranslations(lang as 'en' | 'es');

// Get static posts
const staticPosts: BlogPost[] = (lang === 'en'
	? getAllPosts()
	: getAllPostsEs()) as unknown as BlogPost[];
let post: BlogPost | undefined = staticPosts.find((p) => p.slug === slug);

// If not found in static posts, try StudioCMS - dynamic import to handle conditional availability
let runSDK, SDKCoreJs;
if (!post) {
	try {
		console.log(`[Blog] Searching SDK for slug: ${slug}`);
		({ runSDK, SDKCoreJs } = await import('studiocms:sdk'));
		const allPages = await runSDK(SDKCoreJs.GET.pages());
		const studiocmsPage = allPages
			.map(({ data }: { data: any }) => data)
			.find((page: any) => page.slug === slug && page.package === '@studiocms/blog');

		console.log(`[Blog] Found page:`, studiocmsPage ? 'YES' : 'NO');

		if (studiocmsPage) {
			console.log(`[Blog] Page Title:`, studiocmsPage.title);

			// Fetch full page details to ensure we get the content
			let pageData = studiocmsPage;
			try {
				const fullPageData = await runSDK(SDKCoreJs.GET.page.byId(studiocmsPage.id));
				if (fullPageData) {
					pageData = fullPageData;
				}
			} catch (sdkError) {
				console.warn('[Blog] XML/SDK Fetch failed:', sdkError);
				// Fallback to basic data is already set
			}

			console.log(`[Blog] Full Page keys:`, Object.keys(pageData));

			const contentHtml = pageData.content ? await marked.parse(pageData.content) : '';
			post = {
				slug: studiocmsPage.slug,
				title: studiocmsPage.title || '',
				excerpt: studiocmsPage.excerpt || '',
				date: studiocmsPage.publishedAt
					? new Date(studiocmsPage.publishedAt)
							.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})
							.toUpperCase()
					: '',
				publishedAt: studiocmsPage.publishedAt ? new Date(studiocmsPage.publishedAt) : new Date(0),
				category: studiocmsPage.category || 'BLOG',
				image: studiocmsPage.image || '',
				imageAlt: studiocmsPage.imageAlt || studiocmsPage.title || '',
				content: contentHtml,
				author: {
					name: studiocmsPage.author?.name || 'Mark Tegtmeier',
					image: studiocmsPage.author?.image || '/images/Mark.png',
					bio:
						studiocmsPage.author?.bio ||
						'Founder Mark Tegtmeier brings years of design experience to Trailmerge. He has worked with early stage startups, design and software agencies, government, and enterprise, driving them further in their product vision. A husband of one, father of four, and urban homesteader, Mark loves developing tech talent and coming alongside founders with ambitious visions for their products and companies.',
				},
				fromStudioCMS: true,
			};
		}
	} catch (error) {
		console.warn('StudioCMS post not available:', error);
	}
}

if (!post) {
	return Astro.redirect(`/${lang}/blog`);
}

// Helper function to parse Spanish date format
function parseSpanishDate(dateString: string): Date {
	if (lang === 'en') {
		return new Date(dateString);
	}

	const monthMap: { [key: string]: string } = {
		ENERO: '01',
		FEBRERO: '02',
		MARZO: '03',
		ABRIL: '04',
		MAYO: '05',
		JUNIO: '06',
		JULIO: '07',
		AGOSTO: '08',
		SEPTIEMBRE: '09',
		OCTUBRE: '10',
		NOVIEMBRE: '11',
		DICIEMBRE: '12',
	};

	const match = dateString.match(/(\d+)\s+DE\s+([A-ZÁÉÍÓÚÑ]+),\s+(\d{4})/i);
	if (match) {
		const day = match[1].padStart(2, '0');
		const monthName = match[2].toUpperCase();
		const month = monthMap[monthName] || '01';
		const year = match[3];
		const date = new Date(`${year}-${month}-${day}`);
		if (isNaN(date.getTime())) {
			return new Date();
		}
		return date;
	}

	const fallbackDate = new Date(dateString);
	if (isNaN(fallbackDate.getTime())) {
		return new Date();
	}
	return fallbackDate;
}

// Format category for display (convert single category to multiple if needed)
// For now, we'll use the category as-is, but format it properly
const categoryDisplay = post.category || 'BLOG';

// Prepare article data for JSON-LD schema
// Use safe URL creation for cross-platform compatibility (Windows/Mac)
const articleUrl = safeCreateURL(
	`/${lang}/blog/${post.slug}`,
	Astro.site,
	Astro.url.origin || 'https://trailmerge.com'
);
const articleData = {
	title: post.title,
	description: post.excerpt,
	image: post.image,
	datePublished: parseSpanishDate(post.date).toISOString(),
	author: {
		name: post.author.name,
		image: post.author.image,
	},
	url: articleUrl,
};
---

<Layout
	title={`${post.title} – ${translator('blog.postTitleSuffix')}`}
	description={post.excerpt}
	lang={lang}
	schemaType="article"
	articleData={articleData}
>
	<img
		src="/images/new/blog/blog-post/Vector Blob.svg"
		alt=""
		class="blog-bg-decoration"
		loading="eager"
	/>
	<img
		src="/images/new/blog/blog-post/Vector Blob-2.svg"
		alt=""
		class="blog-blob-decoration-2"
		loading="eager"
	/>
	<img
		src="/images/new/blog/blog-post/Vector Blob-1.svg"
		alt=""
		class="blog-blob-decoration-3"
		loading="eager"
	/>
	<article>
		<PostHero image={post.image} imageAlt={post.imageAlt || post.title} />

		<div class="post-container">
			<PostHeader
				title={post.title}
				date={post.date}
				author={post.author}
				category={categoryDisplay}
			/>

			<PostContent content={post.content} />

			<PostAuthor author={post.author} lang={lang} />
		</div>
	</article>
</Layout>

<style is:global>
	/* Ensure post content titles use Young Serif */
	.post-content-body h2,
	.post-content-body h3,
	.post-content-body h4 {
		font-family: 'Young Serif', serif !important;
		font-weight: 400 !important;
	}
</style>

<style>
	.blog-bg-decoration {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		z-index: -2;
		pointer-events: none;
		opacity: 0.6;
	}

	.blog-blob-decoration-2 {
		position: absolute;
		top: 195px;
		left: 0;
		width: auto;
		height: auto;
		z-index: -1;
		pointer-events: none;
		opacity: 1;
	}

	.blog-blob-decoration-3 {
		position: absolute;
		top: 0;
		right: 0;
		width: auto;
		height: auto;
		z-index: -1;
		pointer-events: none;
		opacity: 1;
	}
</style>
