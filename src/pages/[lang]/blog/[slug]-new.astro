---
// SSR mode - fetch post dynamically
export const prerender = false;

import { getAllPosts } from '../../../data/blogPosts';
import { getAllPostsEs } from '../../../data/blogPosts-es';

export async function getStaticPaths() {
	const enPosts = getAllPosts();
	const esPosts = getAllPostsEs();

	const paths: { params: { lang: string; slug: string } }[] = [];
	enPosts.forEach((post) => paths.push({ params: { lang: 'en', slug: post.slug } }));
	esPosts.forEach((post) => paths.push({ params: { lang: 'es', slug: post.slug } }));

	return paths;
}

import LayoutNew from '../../../layouts/LayoutNew.astro';
import { useTranslations } from '../../../i18n/utils';
import { safeCreateURL } from '../../../utils/urlHelpers';

// Import new redesigned components
import PostHeroNew from '../../../components/new/PostHeroNew.astro';
import PostHeaderNew from '../../../components/new/PostHeaderNew.astro';
import PostContentNew from '../../../components/new/PostContentNew.astro';
import PostAuthorNew from '../../../components/new/PostAuthorNew.astro';

import type { BlogPost } from '../../../types/blog';

const { lang, slug } = Astro.params || { lang: 'en', slug: '' };
const t = useTranslations(lang as 'en' | 'es');

// Get static posts
const staticPosts: BlogPost[] = (lang === 'en'
	? getAllPosts()
	: getAllPostsEs()) as unknown as BlogPost[];
let post: BlogPost | undefined = staticPosts.find((p) => p.slug === slug);

// If not found in static posts, try StudioCMS - dynamic import to handle conditional availability
let runSDK, SDKCoreJs;
if (!post) {
	try {
		({ runSDK, SDKCoreJs } = await import('studiocms:sdk'));
		const allPages = await runSDK(SDKCoreJs.GET.pages());
		const studiocmsPage = allPages
			.map(({ data }: { data: any }) => data)
			.find((page: any) => page.slug === slug && page.package === '@studiocms/blog');

		if (studiocmsPage) {
			post = {
				slug: studiocmsPage.slug,
				title: studiocmsPage.title || '',
				excerpt: studiocmsPage.excerpt || '',
				date: studiocmsPage.publishedAt
					? new Date(studiocmsPage.publishedAt)
							.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})
							.toUpperCase()
					: '',
				publishedAt: studiocmsPage.publishedAt ? new Date(studiocmsPage.publishedAt) : new Date(0),
				category: studiocmsPage.category || 'BLOG',
				image: studiocmsPage.image || '',
				imageAlt: studiocmsPage.imageAlt || studiocmsPage.title || '',
				content: studiocmsPage.content || '',
				author: {
					name: studiocmsPage.author?.name || 'Trailmerge Team',
					image: studiocmsPage.author?.image || '/images/default-author.png',
					bio: studiocmsPage.author?.bio || '',
				},
				fromStudioCMS: true,
			};
		}
	} catch (error) {
		console.warn('StudioCMS post not available:', error);
	}
}

if (!post) {
	return Astro.redirect(`/${lang}/blog-new`);
}

// Helper function to parse Spanish date format
function parseSpanishDate(dateString: string): Date {
	if (lang === 'en') {
		return new Date(dateString);
	}

	const monthMap: { [key: string]: string } = {
		ENERO: '01',
		FEBRERO: '02',
		MARZO: '03',
		ABRIL: '04',
		MAYO: '05',
		JUNIO: '06',
		JULIO: '07',
		AGOSTO: '08',
		SEPTIEMBRE: '09',
		OCTUBRE: '10',
		NOVIEMBRE: '11',
		DICIEMBRE: '12',
	};

	const match = dateString.match(/(\d+)\s+DE\s+([A-ZÁÉÍÓÚÑ]+),\s+(\d{4})/i);
	if (match) {
		const day = match[1].padStart(2, '0');
		const monthName = match[2].toUpperCase();
		const month = monthMap[monthName] || '01';
		const year = match[3];
		const date = new Date(`${year}-${month}-${day}`);
		if (isNaN(date.getTime())) {
			return new Date();
		}
		return date;
	}

	const fallbackDate = new Date(dateString);
	if (isNaN(fallbackDate.getTime())) {
		return new Date();
	}
	return fallbackDate;
}

// Format category for display (convert single category to multiple if needed)
// For now, we'll use the category as-is, but format it properly
const categoryDisplay = post.category || 'BLOG';

// Prepare article data for JSON-LD schema
// Use safe URL creation for cross-platform compatibility (Windows/Mac)
const articleUrl = safeCreateURL(
	`/${lang}/blog/${post.slug}`,
	Astro.site,
	Astro.url.origin || 'https://trailmerge.com'
);
const articleData = {
	title: post.title,
	description: post.excerpt,
	image: post.image,
	datePublished: parseSpanishDate(post.date).toISOString(),
	author: {
		name: post.author.name,
		image: post.author.image,
	},
	url: articleUrl,
};
---

<LayoutNew
	title={`${post.title} – ${t('blog.postTitleSuffix')}`}
	description={post.excerpt}
	lang={lang}
	schemaType="article"
	articleData={articleData}
>
	<PostHeroNew image={post.image} imageAlt={post.imageAlt || post.title} />
	<PostHeaderNew
		title={post.title}
		date={post.date}
		author={post.author}
		category={categoryDisplay}
	/>
	<PostContentNew content={post.content} />
	<PostAuthorNew author={post.author} lang={lang} />
</LayoutNew>

<style is:global>
	/* Ensure post content titles use Young Serif */
	.post-content-body h2,
	.post-content-body h3,
	.post-content-body h4 {
		font-family: 'Young Serif', serif !important;
		font-weight: 400 !important;
	}
</style>
