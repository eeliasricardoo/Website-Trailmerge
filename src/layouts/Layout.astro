---
import { ViewTransitions } from 'astro:transitions';
import SEOSchema from '../components/SEOSchema.astro';
import SEOHead from '../components/SEOHead.astro';
import { getAlternateUrls } from '../utils/routeMapping';
import '../styles/global.css';

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	canonicalURL?: string;
	schemaType?: 'organization' | 'article';
	articleData?: {
		title: string;
		description: string;
		image: string;
		datePublished: string;
		dateModified?: string;
		author: {
			name: string;
			image?: string;
		};
		url: string;
	};
	breadcrumbs?: Array<{
		name: string;
		url: string;
	}>;
	keywords?: string;
	lang?: string;
}

const {
	title = 'UX Design Agency for B2B SaaS Startups â€“ Trailmerge',
	description = 'Scalable SaaS UI/UX services including MVP design, product revamp, and design audits. Schedule a free consultation to get started.',
	ogImage = 'https://uploads-ssl.webflow.com/5f1aca38cd9acd41a07b69f5/616d8bd8b574fcb50a5412be_Home%20Preview%20Image.png',
	canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
	schemaType = 'organization',
	articleData,
	breadcrumbs,
	keywords,
	lang = 'en',
} = Astro.props;

// Get alternate language URLs for hreflang
const currentPath = Astro.url.pathname;
const alternateUrls = getAlternateUrls(currentPath, Astro.site?.href || '');

// Set HTML lang attribute
const htmlLang = lang === 'es' ? 'es' : 'en-US';

// Detect if we're on staging
const isStaging =
	Astro.site?.hostname === 'staging.trailmerge.com' ||
	Astro.url.hostname === 'staging.trailmerge.com';
---

<!doctype html>
<html lang={htmlLang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" type="image/x-icon" href="/images/favicon.png" />
		<meta name="generator" content={Astro.generator} />

		<!-- SEO Meta Tags -->
		<SEOHead
			title={title}
			description={description}
			ogImage={ogImage}
			canonicalURL={canonicalURL}
			lang={lang}
			keywords={keywords}
			alternateUrls={alternateUrls}
			isStaging={isStaging}
		/>

		<!-- Fonts - Optimized with async loading and font-display swap -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

		<!-- Preload critical font files for LCP optimization -->
		<link
			rel="preload"
			href="https://fonts.gstatic.com/s/bitter/v32/raxhHiqOu8IVPmnRc6SY1KXhnF_Y8fbeCL_EXFh2reU.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxK.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>

		<!-- Load fonts asynchronously with print media hack -->
		<link
			href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,500;0,700;1,400&family=Roboto:wght@400;500;700&display=swap"
			rel="stylesheet"
			media="print"
			onload="this.media='all'"
		/>
		<noscript>
			<link
				href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,500;0,700;1,400&family=Roboto:wght@400;500;700&display=swap"
				rel="stylesheet"
			/>
		</noscript>

		<!-- Preconnect and DNS-prefetch for external resources -->
		<link rel="preconnect" href="https://images.unsplash.com" />
		<link rel="preconnect" href="https://uploads-ssl.webflow.com" />
		<link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
		<link rel="dns-prefetch" href="https://t.contentsquare.net" />

		<!-- Cookie Consent - Silktide (async loading) -->
		<link
			rel="stylesheet"
			type="text/css"
			href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"
			media="print"
			onload="this.media='all'"
		/>
		<script
			is:inline
			src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
			async
			data-cfasync="false"></script>

		<!-- Analytics (async loading) -->
		<script is:inline src="https://t.contentsquare.net/uxa/ecd5d357203b8.js" async></script>

		<!-- Structured Data (JSON-LD) -->
		<SEOSchema
			type={schemaType}
			articleData={articleData}
			breadcrumbs={breadcrumbs}
			pageTitle={title}
			pageDescription={description}
		/>

		<!-- View Transitions for smooth page navigation -->
		<ViewTransitions />
	</head>
	<body>
		<a href="#main-content" class="skip-to-content">Skip to main content</a>
		<slot />

		<!-- Cookie Consent Initialization -->
		<script>
			import { initCookieConsent } from '../scripts/cookieConsent';

			// Get language from HTML tag
			const htmlLang = document.documentElement.lang;
			const lang = htmlLang === 'es' || htmlLang === 'es-ES' ? 'es' : 'en';

			// Initialize cookie consent on load
			window.addEventListener('load', () => {
				initCookieConsent(lang);
			});
		</script>
	</body>
</html>
