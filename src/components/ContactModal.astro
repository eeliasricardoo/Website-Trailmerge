---
import { useTranslations } from '../i18n/utils';
import CoffeeImage from '../assets/images/Coffee.png';

export interface Props {
	image?: any;
	title?: string;
	description?: string;
	lang?: string;
}

const { lang = 'en' } = Astro.props;
const t = useTranslations(lang as 'en' | 'es');

const {
	image = CoffeeImage,
	title = t('contact.title'),
	description = t('contact.description')
} = Astro.props;

// Copper form URLs based on language
const copperFormUrl = lang === 'es'
	? 'https://forms.copper.com/j/wYsDRF6aDG9YgnPCCJjiXJ?type=embed'
	: 'https://forms.copper.com/j/5dNTzeqzanj9McnokQfpFq?type=embed';

const copperFormId = lang === 'es'
	? 'wYsDRF6aDG9YgnPCCJjiXJ'
	: '5dNTzeqzanj9McnokQfpFq';
---

<!-- Contact Modal -->
<div class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
	<div class="contact-modal">
		<div class="modal-columns">
			<div class="modal-column centered">
				<img src={image.src} loading="lazy" alt="Coffee cup illustration representing consultation meeting" class="modal-image" />
				<h3 id="modal-title">{title}</h3>
				<p>{description}</p>
			</div>
			<div class="modal-column">
				<div class="form-block copper-form-container">
					<iframe
						src={copperFormUrl}
						id={copperFormId}
						title="Embedded Copper Forms"
						width="100%"
						height="700"
					></iframe>
				</div>
			</div>
		</div>
		<button class="close-modal" aria-label={t('contact.form.closeButton')}>✕</button>
	</div>
</div>

<script>
	// Modal functionality
	document.addEventListener('DOMContentLoaded', function() {
		const modalBackdrop = document.querySelector('.modal-backdrop');
		const openModalButtons = document.querySelectorAll('.open-modal');
		const closeModalButton = document.querySelector('.close-modal');
		const calendarUrl = 'https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ2E0Pl1V454vAAYQJxhS2H0Q4vxa_6-sgcUXQB4cBaCn_jtRYLNMGMp-ka5p-cuCkExM8X1fC19';

		if (!modalBackdrop || !closeModalButton) return;

		// Open modal
		openModalButtons.forEach(button => {
			button.addEventListener('click', function(e) {
				e.preventDefault();
				modalBackdrop.classList.add('active');
				document.body.style.overflow = 'hidden';
			});
		});

		// Close modal
		closeModalButton.addEventListener('click', function(e) {
			e.preventDefault();
			modalBackdrop.classList.remove('active');
			document.body.style.overflow = 'auto';
		});

		// Close modal when clicking backdrop
		modalBackdrop.addEventListener('click', function(e) {
			if (e.target === modalBackdrop) {
				modalBackdrop.classList.remove('active');
				document.body.style.overflow = 'auto';
			}
		});

		// Close modal with Escape key
		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape' && modalBackdrop.classList.contains('active')) {
				modalBackdrop.classList.remove('active');
				document.body.style.overflow = 'auto';
			}
		});

		// Listen for form submission success from Copper Forms iframe
		// Copper Forms sends postMessage when form is submitted successfully
		window.addEventListener('message', function(event) {
			// Check if message is from Copper Forms domain
			if (event.origin.includes('copper.com') || event.origin.includes('forms.copper.com')) {
				// Check for form submission success messages
				if (event.data && (
					event.data.type === 'form-submit' ||
					event.data.type === 'copper-form-submit' ||
					event.data.status === 'success' ||
					event.data.message === 'form-submitted' ||
					typeof event.data === 'string' && event.data.includes('success')
				)) {
					// Close modal and redirect to calendar
					modalBackdrop.classList.remove('active');
					document.body.style.overflow = 'auto';
					window.location.href = calendarUrl;
				}
			}
		});

		// Fallback: Monitor iframe for form submission indicators
		// Check iframe content changes and URL changes that might indicate successful submission
		const iframe = document.querySelector('iframe[id^="wYsDRF6aDG9YgnPCCJjiXJ"], iframe[id^="5dNTzeqzanj9McnokQfpFq"]');
		if (iframe) {
			let checkCount = 0;
			const maxChecks = 60; // Check for up to 30 seconds (500ms * 60)
			let lastIframeUrl = iframe.src;
			let formSubmitted = false;
			
			// Listen for iframe load events (happens when form redirects after submission)
			iframe.addEventListener('load', function() {
				// Small delay to allow success page to render
				setTimeout(() => {
					if (!formSubmitted) {
						try {
							const currentUrl = iframe.contentWindow?.location.href || iframe.src;
							// If URL changed from original embed URL, form was likely submitted
							if (currentUrl && currentUrl !== lastIframeUrl && !currentUrl.includes('type=embed')) {
								formSubmitted = true;
								modalBackdrop.classList.remove('active');
								document.body.style.overflow = 'auto';
								window.location.href = calendarUrl;
							}
						} catch (e) {
							// CORS error - can't access iframe URL
						}
					}
				}, 1000);
			});
			
			const checkInterval = setInterval(() => {
				if (formSubmitted) {
					clearInterval(checkInterval);
					return;
				}
				
				checkCount++;
				
				// Check if iframe URL changed (indicates form submission/redirect)
				try {
					const currentUrl = iframe.contentWindow?.location.href || iframe.src;
					if (currentUrl && currentUrl !== lastIframeUrl && !currentUrl.includes('type=embed')) {
						// URL changed, likely form was submitted
						formSubmitted = true;
						clearInterval(checkInterval);
						modalBackdrop.classList.remove('active');
						document.body.style.overflow = 'auto';
						window.location.href = calendarUrl;
						return;
					}
					lastIframeUrl = currentUrl || lastIframeUrl;
				} catch (e) {
					// CORS error - can't access iframe URL
				}
				
				try {
					// Try to access iframe content (may fail due to CORS)
					const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
					if (iframeDoc) {
						// Look for success indicators in the iframe
						const successElements = iframeDoc.querySelectorAll(
							'[class*="success"], [class*="thank"], [id*="success"], [id*="thank"], .success-message, .thank-you, [data-success]'
						);
						
						if (successElements.length > 0) {
							formSubmitted = true;
							clearInterval(checkInterval);
							modalBackdrop.classList.remove('active');
							document.body.style.overflow = 'auto';
							window.location.href = calendarUrl;
							return;
						}
					}
				} catch (e) {
					// CORS error - can't access iframe content, rely on postMessage
				}
				
				// Stop checking after max attempts
				if (checkCount >= maxChecks) {
					clearInterval(checkInterval);
				}
			}, 500);

			// Stop checking when modal is closed
			const stopChecking = () => {
				clearInterval(checkInterval);
			};
			
			closeModalButton.addEventListener('click', stopChecking);
			modalBackdrop.addEventListener('click', function(e) {
				if (e.target === modalBackdrop) {
					stopChecking();
				}
			});
		}
	});
</script>

<style>
	/* Modal backdrop */
	.modal-backdrop {
		overflow: hidden;
		align-items: center;
		justify-content: center;
		padding: 1rem;
	}

	.copper-form-container {
		width: 100%;
		overflow: visible !important;
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100%;
		min-height: 100%;
	}

	.copper-form-container iframe {
		width: 100%;
		border: none;
		height: 650px;
		max-height: 100%;
		overflow: visible !important;
		margin: auto;
		display: block;
		vertical-align: middle;
	}

	/* Ajustar altura do modal para acomodar o iframe */
	.contact-modal {
		max-height: 95vh;
		height: auto;
		min-height: 600px;
		overflow: hidden !important;
		padding: 2rem;
		margin: auto;
		display: flex;
		flex-direction: column;
	}

	/* Ajustar colunas do modal */
	.modal-columns {
		display: grid;
		grid-template-columns: 1fr 1.2fr;
		gap: 3rem;
		align-items: stretch;
		max-height: none;
		min-height: 500px;
		height: 100%;
	}

	/* Centralizar imagem e conteúdo */
	.modal-column.centered {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		text-align: center;
		padding: 2rem 1rem;
	}

	.modal-column.centered .modal-image {
		margin: 0 auto 2rem;
		display: block;
		max-width: 280px;
		width: 100%;
		height: auto;
	}

	.modal-column.centered h3 {
		margin-bottom: 1rem;
		font-size: 1.75rem;
		line-height: 1.3;
	}

	.modal-column.centered p {
		margin: 0;
		font-size: 1rem;
		line-height: 1.6;
		max-width: 350px;
	}

	/* Ajustar coluna do formulário */
	.modal-column:not(.centered) {
		height: 100%;
		min-height: 500px;
		max-height: none;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		position: relative;
		padding: 2rem 1rem;
	}

	.modal-column.centered {
		height: auto;
	}

	.form-block {
		width: 100%;
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100%;
		min-height: 100%;
		flex: 1;
	}

	/* Botão de fechar */
	.close-modal {
		position: absolute;
		top: 1.5rem;
		right: 1.5rem;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		transition: transform 0.2s ease;
	}

	.close-modal:hover {
		transform: scale(1.1);
	}

	@media (max-width: 991px) {
		.modal-columns {
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		.contact-modal {
			padding: 1.5rem;
			max-height: 95vh;
			overflow: hidden !important;
		}

		.modal-column.centered {
			padding: 1rem;
		}

		.modal-column.centered .modal-image {
			max-width: 200px;
			margin-bottom: 1.5rem;
		}

		.modal-column.centered h3 {
			font-size: 1.5rem;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}
	}

	@media (max-width: 768px) {
		.copper-form-container iframe {
			height: 550px;
			max-height: 550px;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}

		.close-modal {
			top: 1rem;
			right: 1rem;
			width: 36px;
			height: 36px;
		}
	}

	@media (max-width: 479px) {
		.contact-modal {
			padding: 1rem;
		}

		.modal-column.centered .modal-image {
			max-width: 160px;
			margin-bottom: 1rem;
		}

		.modal-column.centered h3 {
			font-size: 1.25rem;
			margin-bottom: 0.75rem;
		}

		.modal-column.centered p {
			font-size: 0.9rem;
		}

		.copper-form-container iframe {
			height: 500px;
			max-height: 500px;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}
	}
</style>
