---
import { useTranslations } from '../i18n/utils';
import CoffeeImage from '../assets/images/Coffee.png';

export interface Props {
	image?: any;
	title?: string;
	description?: string;
	lang?: string;
}

const { lang = 'en' } = Astro.props;
const t = useTranslations(lang as 'en' | 'es');

const {
	image = CoffeeImage,
	title = t('contact.title'),
	description = t('contact.description'),
} = Astro.props;

// Copper form URLs based on language
const copperFormUrl =
	lang === 'es'
		? 'https://forms.copper.com/j/wYsDRF6aDG9YgnPCCJjiXJ?type=embed'
		: 'https://forms.copper.com/j/5dNTzeqzanj9McnokQfpFq?type=embed';

const copperFormId = lang === 'es' ? 'wYsDRF6aDG9YgnPCCJjiXJ' : '5dNTzeqzanj9McnokQfpFq';
---

<!-- Contact Modal -->
<div class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
	<div class="contact-modal">
		<div class="modal-columns">
			<div class="modal-column centered">
				<img
					src={image.src}
					loading="lazy"
					alt="Coffee cup illustration representing consultation meeting"
					class="modal-image"
				/>
				<h3 id="modal-title">{title}</h3>
				<p>{description}</p>
			</div>
			<div class="modal-column">
				<div class="form-block copper-form-container">
					<iframe
						src={copperFormUrl}
						id={copperFormId}
						title="Embedded Copper Forms"
						width="100%"
						height="700"
						loading="eager"></iframe>
				</div>
			</div>
		</div>
		<button class="close-modal" aria-label={t('contact.form.closeButton')}>✕</button>
	</div>
</div>

<script>
	// Modal functionality
	document.addEventListener('DOMContentLoaded', function () {
		const modalBackdrop = document.querySelector('.modal-backdrop');
		const openModalButtons = document.querySelectorAll('.open-modal');
		const closeModalButton = document.querySelector('.close-modal');
		const calendarUrl =
			'https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ2E0Pl1V454vAAYQJxhS2H0Q4vxa_6-sgcUXQB4cBaCn_jtRYLNMGMp-ka5p-cuCkExM8X1fC19';

		if (!modalBackdrop || !closeModalButton) return;

		// Flag to prevent multiple redirects
		let hasRedirected = false;

		// Function to redirect to calendar (only once)
		const redirectToCalendar = () => {
			if (hasRedirected) return;
			hasRedirected = true;
			modalBackdrop.classList.remove('active');
			document.body.style.overflow = 'auto';
			window.location.href = calendarUrl;
		};

		// Reset redirect flag when modal opens
		openModalButtons.forEach((button) => {
			button.addEventListener('click', function (e) {
				e.preventDefault();
				hasRedirected = false; // Reset flag on modal open
				modalBackdrop.classList.add('active');
				document.body.style.overflow = 'hidden';
			});
		});

		// Close modal
		closeModalButton.addEventListener('click', function (e) {
			e.preventDefault();
			modalBackdrop.classList.remove('active');
			document.body.style.overflow = 'auto';
		});

		// Close modal when clicking backdrop
		modalBackdrop.addEventListener('click', function (e) {
			if (e.target === modalBackdrop) {
				modalBackdrop.classList.remove('active');
				document.body.style.overflow = 'auto';
			}
		});

		// Close modal with Escape key
		document.addEventListener('keydown', function (e) {
			if (e.key === 'Escape' && modalBackdrop.classList.contains('active')) {
				modalBackdrop.classList.remove('active');
				document.body.style.overflow = 'auto';
			}
		});

		// Listen for form submission success from Copper Forms iframe
		// Copper Forms sends postMessage when form is submitted successfully
		window.addEventListener('message', function (event) {
			// Only process if modal is open and haven't redirected yet
			if (!modalBackdrop.classList.contains('active') || hasRedirected) return;

			// Check if message is from Copper Forms domain
			if (event.origin.includes('copper.com') || event.origin.includes('forms.copper.com')) {
				// Check for SPECIFIC form submission success messages from Copper Forms
				if (
					event.data &&
					typeof event.data === 'object' &&
					(event.data.type === 'form-submit' ||
						event.data.type === 'copper-form-submit' ||
						(event.data.status === 'success' && event.data.type) ||
						event.data.message === 'form-submitted')
				) {
					console.log('Form submission detected via postMessage:', event.data);
					redirectToCalendar();
				}
			}
		});

		// Fallback: Monitor iframe URL changes (more reliable than DOM inspection)
		const iframe = document.querySelector(
			'iframe[id^="wYsDRF6aDG9YgnPCCJjiXJ"], iframe[id^="5dNTzeqzanj9McnokQfpFq"]'
		) as HTMLIFrameElement | null;
		if (iframe) {
			const originalUrl = iframe.src;
			let checkInterval: number | undefined = undefined;

			// Listen for iframe load events (happens when form redirects after submission)
			iframe.addEventListener('load', function () {
				// Only check if modal is open
				if (!modalBackdrop.classList.contains('active') || hasRedirected) return;

				// Wait a bit to allow iframe to settle
				setTimeout(() => {
					if (hasRedirected || !modalBackdrop.classList.contains('active')) return;

					try {
						const currentUrl = iframe.contentWindow?.location.href || iframe.src;
						// Check if URL changed to a non-embed URL (indicates form submission redirect)
						if (currentUrl && currentUrl !== originalUrl && !currentUrl.includes('type=embed')) {
							console.log('Form submission detected via URL change:', currentUrl);
							redirectToCalendar();
						}
					} catch (e) {
						// CORS error - can't access iframe URL, rely on postMessage
					}
				}, 1500);
			});

			// Periodic check as additional fallback (less aggressive)
			const startChecking = () => {
				if (checkInterval) clearInterval(checkInterval);

				let checkCount = 0;
				const maxChecks = 40; // Check for up to 20 seconds (500ms * 40)

				checkInterval = window.setInterval(() => {
					// Stop if modal closed or already redirected
					if (!modalBackdrop.classList.contains('active') || hasRedirected) {
						clearInterval(checkInterval);
						return;
					}

					checkCount++;

					try {
						const currentUrl = iframe.contentWindow?.location.href;
						if (currentUrl && currentUrl !== originalUrl && !currentUrl.includes('type=embed')) {
							console.log('Form submission detected via periodic check:', currentUrl);
							clearInterval(checkInterval);
							redirectToCalendar();
							return;
						}
					} catch (e) {
						// CORS error - expected, rely on other methods
					}

					// Stop checking after max attempts
					if (checkCount >= maxChecks) {
						clearInterval(checkInterval);
					}
				}, 500);
			};

			// Start checking when modal opens
			openModalButtons.forEach((button) => {
				button.addEventListener('click', function () {
					startChecking();
				});
			});

			// Stop checking when modal closes
			const stopChecking = () => {
				if (checkInterval) {
					clearInterval(checkInterval);
					checkInterval = undefined;
				}
			};

			closeModalButton.addEventListener('click', stopChecking);
			modalBackdrop.addEventListener('click', function (e) {
				if (e.target === modalBackdrop) {
					stopChecking();
				}
			});
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Escape' && modalBackdrop.classList.contains('active')) {
					stopChecking();
				}
			});
		}
	});
</script>

<style>
	/* Modal backdrop */
	.modal-backdrop {
		overflow: hidden;
		align-items: center;
		justify-content: center;
		padding: 1rem;
	}

	.copper-form-container {
		width: 100%;
		overflow: visible !important;
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100%;
		min-height: 100%;
	}

	.copper-form-container iframe {
		width: 100%;
		border: none;
		height: 650px;
		max-height: 100%;
		overflow: visible !important;
		margin: auto;
		display: block;
		vertical-align: middle;
	}

	/* Ajustar altura do modal para acomodar o iframe */
	.contact-modal {
		max-height: 95vh;
		height: auto;
		min-height: 600px;
		overflow: hidden !important;
		padding: 2rem;
		margin: auto;
		display: flex;
		flex-direction: column;
	}

	/* Ajustar colunas do modal */
	.modal-columns {
		display: grid;
		grid-template-columns: 1fr 1.2fr;
		gap: 3rem;
		align-items: stretch;
		max-height: none;
		min-height: 500px;
		height: 100%;
	}

	/* Centralizar imagem e conteúdo */
	.modal-column.centered {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		text-align: center;
		padding: 2rem 1rem;
	}

	.modal-column.centered .modal-image {
		margin: 0 auto 2rem;
		display: block;
		max-width: 280px;
		width: 100%;
		height: auto;
	}

	.modal-column.centered h3 {
		margin-bottom: 1rem;
		font-size: 1.75rem;
		line-height: 1.3;
	}

	.modal-column.centered p {
		margin: 0;
		font-size: 1rem;
		line-height: 1.6;
		max-width: 350px;
	}

	/* Ajustar coluna do formulário */
	.modal-column:not(.centered) {
		height: 100%;
		min-height: 500px;
		max-height: none;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		position: relative;
		padding: 2rem 1rem;
	}

	.modal-column.centered {
		height: auto;
	}

	.form-block {
		width: 100%;
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100%;
		min-height: 100%;
		flex: 1;
	}

	/* Botão de fechar */
	.close-modal {
		position: absolute;
		top: 1.5rem;
		right: 1.5rem;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		transition: transform 0.2s ease;
	}

	.close-modal:hover {
		transform: scale(1.1);
	}

	@media (max-width: 991px) {
		.modal-columns {
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		.contact-modal {
			padding: 1.5rem;
			max-height: 95vh;
			overflow: hidden !important;
		}

		.modal-column.centered {
			padding: 1rem;
		}

		.modal-column.centered .modal-image {
			max-width: 200px;
			margin-bottom: 1.5rem;
		}

		.modal-column.centered h3 {
			font-size: 1.5rem;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}
	}

	@media (max-width: 768px) {
		.copper-form-container iframe {
			height: 550px;
			max-height: 550px;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}

		.close-modal {
			top: 1rem;
			right: 1rem;
			width: 36px;
			height: 36px;
		}
	}

	@media (max-width: 479px) {
		.contact-modal {
			padding: 1rem;
		}

		.modal-column.centered .modal-image {
			max-width: 160px;
			margin-bottom: 1rem;
		}

		.modal-column.centered h3 {
			font-size: 1.25rem;
			margin-bottom: 0.75rem;
		}

		.modal-column.centered p {
			font-size: 0.9rem;
		}

		.copper-form-container iframe {
			height: 500px;
			max-height: 500px;
		}

		.modal-column {
			height: auto;
			max-height: none;
		}
	}
</style>
