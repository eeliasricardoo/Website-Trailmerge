---
import { useTranslations } from '../../i18n/utils';

import type { BlogPost } from '../../types/blog';

export interface Props {
	lang?: string;
	posts: BlogPost[];
}

const { lang = 'en', posts = [] } = Astro.props;
const t = useTranslations(lang as 'en' | 'es');

// Get featured posts (first 4 posts)
const featuredPosts = posts.slice(0, 4);
const mainPost = featuredPosts[0];
const sidePosts = featuredPosts.slice(1, 4);
---

<!-- Featured Posts Section -->
<section class="featured-posts-wrapper">
	<div class="featured-posts-container">
		<h2 class="section-title">{t('blog.featured')}</h2>
		<div class="featured-posts-grid">
			{
				mainPost && (
					<article class="featured-main-card">
						<a href={`/${lang}/blog/${mainPost.slug}/`} class="featured-main-link">
							<div class="featured-main-image-wrapper">
								<img
									src={mainPost.image}
									alt={mainPost.imageAlt || mainPost.title}
									class="featured-main-image"
									loading="eager"
								/>
							</div>
							<div class="featured-main-content">
								<h3 class="featured-main-title">{mainPost.title}</h3>
								<div class="featured-main-meta">
									<span class="featured-main-date">{mainPost.date}</span>
									{mainPost.author && (
										<span class="featured-main-author"> • {mainPost.author.name}</span>
									)}
								</div>
							</div>
						</a>
					</article>
				)
			}
			<div class="featured-side-posts">
				{
					sidePosts.map((post) => (
						<article class="featured-side-card">
							<a href={`/${lang}/blog/${post.slug}/`} class="featured-side-link">
								<div class="featured-side-image-wrapper">
									<img
										src={post.image}
										alt={post.imageAlt || post.title}
										class="featured-side-image"
										loading="lazy"
									/>
								</div>
								<div class="featured-side-content">
									<h4 class="featured-side-title">{post.title}</h4>
									<div class="featured-side-meta">
										<span class="featured-side-date">{post.date}</span>
										{post.author && <span class="featured-side-author"> • {post.author.name}</span>}
									</div>
								</div>
							</a>
						</article>
					))
				}
			</div>
		</div>
		<!-- Mobile Slider -->
		<div class="featured-slider-mobile">
			<div class="slider-container">
				<div class="slider-track" id="slider-track">
					{
						featuredPosts.map((post, index) => (
							<article class="slider-slide" data-slide-index={index}>
								<a href={`/${lang}/blog/${post.slug}/`} class="slider-link">
									<div class="slider-image-wrapper">
										<img
											src={post.image}
											alt={post.imageAlt || post.title}
											class="slider-image"
											loading={index === 0 ? 'eager' : 'lazy'}
										/>
									</div>
									<div class="slider-content">
										<h3 class="slider-title">{post.title}</h3>
										<div class="slider-meta">
											<span class="slider-date">{post.date}</span>
											{post.author && <span class="slider-author"> • {post.author.name}</span>}
										</div>
									</div>
								</a>
							</article>
						))
					}
				</div>
			</div>
			<div class="slider-bullets" id="slider-bullets">
				{
					featuredPosts.map((_, index) => (
						<button
							class={`slider-bullet ${index === 0 ? 'active' : ''}`}
							data-slide-index={index}
							aria-label={`Go to slide ${index + 1}`}
						/>
					))
				}
			</div>
		</div>
	</div>
</section>

<script>
	function initSlider() {
		const slider = document.querySelector('.featured-slider-mobile');
		if (!slider) return;

		const track = slider.querySelector('.slider-track') as HTMLElement;
		const slides = Array.from(slider.querySelectorAll('.slider-slide')) as HTMLElement[];
		const bullets = Array.from(slider.querySelectorAll('.slider-bullet')) as HTMLButtonElement[];
		const container = slider.querySelector('.slider-container') as HTMLElement;

		if (slides.length === 0 || !track || !container || bullets.length === 0) {
			return;
		}

		let currentIndex = 0;
		let containerWidth = 0;

		const getContainerWidth = () => {
			const rect = container.getBoundingClientRect();
			return rect.width;
		};

		const updateSlider = () => {
			containerWidth = getContainerWidth();
			if (containerWidth === 0) {
				requestAnimationFrame(updateSlider);
				return;
			}

			const translateX = -currentIndex * containerWidth;
			track.style.transform = `translateX(${translateX}px)`;

			// Remove active class from all bullets first
			bullets.forEach((bullet) => {
				bullet.classList.remove('active');
			});

			// Add active class only to the current bullet
			if (bullets[currentIndex]) {
				bullets[currentIndex].classList.add('active');
			}
		};

		// Set up bullet click handlers
		bullets.forEach((bullet, index) => {
			bullet.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();

				const targetIndex = parseInt(bullet.getAttribute('data-slide-index') || '0', 10);
				if (targetIndex >= 0 && targetIndex < slides.length) {
					currentIndex = targetIndex;
					updateSlider();
				}
			});
		});

		// Touch/swipe support
		let startX = 0;
		let isDragging = false;
		let currentTranslate = 0;

		const handleTouchStart = (e: TouchEvent) => {
			startX = e.touches[0].clientX;
			isDragging = true;
			containerWidth = getContainerWidth();
			currentTranslate = -currentIndex * containerWidth;
			track.style.transition = 'none';
		};

		const handleTouchMove = (e: TouchEvent) => {
			if (!isDragging) return;
			const currentX = e.touches[0].clientX;
			const diff = startX - currentX;
			const newTranslate = currentTranslate - diff;
			track.style.transform = `translateX(${newTranslate}px)`;
		};

		const handleTouchEnd = (e: TouchEvent) => {
			if (!isDragging) return;
			isDragging = false;
			track.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

			const endX = e.changedTouches[0].clientX;
			const diff = startX - endX;
			const threshold = 50;

			if (Math.abs(diff) > threshold) {
				if (diff > 0 && currentIndex < slides.length - 1) {
					currentIndex++;
				} else if (diff < 0 && currentIndex > 0) {
					currentIndex--;
				}
			}
			updateSlider();
		};

		track.addEventListener('touchstart', handleTouchStart, { passive: true });
		track.addEventListener('touchmove', handleTouchMove, { passive: true });
		track.addEventListener('touchend', handleTouchEnd, { passive: true });

		// Handle window resize
		let resizeTimeout: ReturnType<typeof setTimeout>;
		const handleResize = () => {
			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(() => {
				updateSlider();
			}, 250);
		};

		window.addEventListener('resize', handleResize);

		// Initialize slider - remove all active classes first, then set the correct one
		bullets.forEach((bullet) => bullet.classList.remove('active'));
		currentIndex = 0;
		setTimeout(() => {
			updateSlider();
		}, 100);
	}

	// Initialize on page load
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initSlider);
	} else {
		initSlider();
	}

	document.addEventListener('astro:page-load', initSlider);
</script>

<style>
	.featured-posts-wrapper {
		width: 100%;
		padding: 88px 24px 72px 24px;
		background-color: transparent;
		position: relative;
		z-index: 1;
	}

	.featured-posts-container {
		max-width: 1200px;
		margin: 0 auto;
	}

	.section-title {
		color: var(--brand-secondary-brown);
		font-family: 'Young Serif', serif;
		font-size: 56px;
		font-weight: 400;
		line-height: 1.2;
		margin: 0 0 24px 0;
	}

	.featured-posts-grid {
		display: grid;
		grid-template-columns: 640px 1fr;
		gap: 40px;
		align-items: start;
	}

	.featured-main-card {
		display: flex;
		flex-direction: column;
	}

	.featured-main-link {
		text-decoration: none;
		color: inherit;
		display: flex;
		flex-direction: column;
		gap: 24px;
		transition: transform 0.3s ease;
	}

	.featured-main-link:hover {
		transform: translateY(-4px);
	}

	.featured-main-image-wrapper {
		width: 640px;
		height: 480px;
		border-radius: 8px;
		overflow: hidden;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		opacity: 1;
		transform: rotate(0deg);
	}

	.featured-main-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.featured-main-content {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.featured-main-title {
		color: var(--brand-secondary-brown);
		font-family: 'Young Serif', serif;
		font-size: 32px;
		font-weight: 400;
		line-height: 1.3;
		margin: 0;
	}

	.featured-main-meta {
		color: var(--brand-secondary-brown);
		font-family: 'DM Sans', sans-serif;
		font-size: 20px;
		font-style: normal;
		font-weight: 400;
		line-height: 28px;
		letter-spacing: 0;
	}

	.featured-side-posts {
		display: flex;
		flex-direction: column;
		gap: 16px;
	}

	.featured-side-card {
		display: flex;
		flex-direction: column;
	}

	.featured-side-link {
		text-decoration: none;
		color: inherit;
		display: flex;
		gap: 16px;
		transition: transform 0.3s ease;
	}

	.featured-side-link:hover {
		transform: translateY(-2px);
	}

	.featured-side-image-wrapper {
		width: 276px;
		min-width: 276px;
		height: 176px;
		border-radius: 8px;
		overflow: hidden;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		opacity: 1;
		transform: rotate(0deg);
	}

	.featured-side-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.featured-side-content {
		display: flex;
		flex-direction: column;
		gap: 8px;
		flex: 1;
	}

	.featured-side-title {
		color: #54504b;
		text-shadow: 0 -1px 2px rgba(0, 0, 0, 0.25);
		font-family: 'Young Serif', serif;
		font-size: 28px;
		font-style: normal;
		font-weight: 400;
		line-height: 36px;
		letter-spacing: 0.84px;
		margin: 0;
	}

	.featured-side-meta {
		color: var(--brand-secondary-brown);
		font-family: 'DM Sans', sans-serif;
		font-size: 20px;
		font-style: normal;
		font-weight: 400;
		line-height: 28px;
		letter-spacing: 0;
	}

	@media (max-width: 1024px) {
		.featured-posts-grid {
			gap: 32px;
		}

		.featured-side-image-wrapper {
			width: 150px;
			min-width: 150px;
		}
	}

	/* Mobile Slider Styles */
	.featured-slider-mobile {
		display: none;
		width: 100%;
	}

	.slider-container {
		width: 100%;
		overflow: hidden;
		position: relative;
	}

	.slider-track {
		display: flex;
		transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		will-change: transform;
	}

	.slider-slide {
		min-width: 100%;
		width: 100%;
		flex-shrink: 0;
		padding: 0;
		box-sizing: border-box;
	}

	.slider-link {
		text-decoration: none;
		color: inherit;
		display: flex;
		flex-direction: column;
		gap: 16px;
		width: 100%;
	}

	.slider-image-wrapper {
		width: 100%;
		aspect-ratio: 16/9;
		max-height: 240px;
		border-radius: 8px;
		overflow: hidden;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		background-color: #f5f5f5;
	}

	.slider-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.slider-content {
		display: flex;
		flex-direction: column;
		gap: 8px;
		padding: 0;
	}

	.slider-title {
		color: var(--brand-secondary-brown);
		font-family: 'Young Serif', serif;
		font-size: 24px;
		font-weight: 400;
		line-height: 1.3;
		margin: 0;
	}

	.slider-meta {
		color: var(--brand-secondary-brown);
		font-family: 'DM Sans', sans-serif;
		font-size: 20px;
		font-style: normal;
		font-weight: 400;
		line-height: 28px;
		letter-spacing: 0;
	}

	.slider-bullets {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 8px;
		margin-top: 24px;
		padding: 0;
	}

	.slider-bullet {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		border: none;
		background-color: rgba(84, 80, 75, 0.3);
		cursor: pointer;
		padding: 0;
		transition:
			background-color 0.3s ease,
			transform 0.3s ease;
		outline: none;
	}

	.slider-bullet:hover {
		background-color: rgba(84, 80, 75, 0.5);
		transform: scale(1.1);
	}

	.slider-bullet.active {
		background-color: var(--brand-secondary-brown);
		transform: scale(1.2);
	}

	@media (max-width: 768px) {
		.featured-posts-wrapper {
			padding: 72px 24px;
		}

		.section-title {
			font-size: 40px;
			margin-bottom: 40px;
		}

		.featured-posts-grid {
			display: none;
		}

		.featured-slider-mobile {
			display: block;
		}

		.slider-image-wrapper {
			aspect-ratio: unset;
			height: 340px;
			max-height: 340px;
		}
	}

	@media (max-width: 480px) {
		.featured-posts-wrapper {
			padding: 48px 16px;
		}

		.section-title {
			font-size: 36px;
			margin-bottom: 32px;
		}

		.slider-image-wrapper {
			aspect-ratio: unset;
			height: 300px;
			max-height: 300px;
		}

		.slider-title {
			font-size: 24px;
		}

		.slider-meta {
			font-size: 13px;
		}
	}
</style>
