name: Deploy to Google Cloud Storage

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        env:
          MANUAL_ENV: ${{ github.event.inputs.environment }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e  # Exit on error
          
          # Determinar el entorno basado en la rama o input manual
          if [ "$MANUAL_ENV" = "auto" ] || [ -z "$MANUAL_ENV" ]; then
            # Auto-detect basado en la rama
            if [ "$BRANCH" = "staging" ]; then
              ENVIRONMENT="staging"
            elif [ "$BRANCH" = "main" ]; then
              ENVIRONMENT="production"
            else
              echo "‚ùå Error: No se puede determinar el entorno para la rama $BRANCH"
              echo "Usa workflow_dispatch con un entorno espec√≠fico"
              exit 1
            fi
          else
            ENVIRONMENT="$MANUAL_ENV"
          fi
          
          if [ "$ENVIRONMENT" = "staging" ]; then
            BUCKET="staging.trailmerge.com"
            MAKE_PUBLIC=false
          else
            BUCKET="trailmerge.com"
            MAKE_PUBLIC=true
          fi
          
          echo "üöÄ Deploying to $BUCKET ($ENVIRONMENT) from branch $BRANCH"
          
          # Verificar que el directorio dist existe
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: El directorio dist/ no existe"
            exit 1
          fi
          
          # Verificar que gsutil est√° disponible
          if ! command -v gsutil &> /dev/null; then
            echo "‚ùå Error: gsutil no est√° disponible"
            exit 1
          fi
          
          # Verificar permisos del bucket
          echo "üìã Verificando acceso al bucket..."
          if ! gsutil ls gs://$BUCKET &> /dev/null; then
            echo "‚ùå Error: No se puede acceder al bucket gs://$BUCKET"
            echo "Verifica que el service account tenga permisos Storage Admin o Storage Object Admin"
            exit 1
          fi
          
          # Subir archivos
          echo "üì§ Subiendo archivos..."
          gsutil -m rsync -r -d dist/ gs://$BUCKET || {
            echo "‚ùå Error al subir archivos"
            exit 1
          }
          
          # Configurar p√°gina principal
          echo "‚öôÔ∏è  Configurando p√°gina principal..."
          gsutil web set -m index.html gs://$BUCKET || {
            echo "‚ùå Error al configurar p√°gina principal"
            exit 1
          }
          
          # Configurar permisos p√∫blicos solo para production
          if [ "$MAKE_PUBLIC" = "true" ]; then
            echo "üåê Configurando permisos p√∫blicos..."
            gsutil iam ch allUsers:objectViewer gs://$BUCKET || echo "‚ö†Ô∏è  Note: Bucket may have public access prevention enabled"
          else
            echo "üîí Staging bucket remains private (authentication required)"
          fi
          
          echo "‚úÖ Despliegue completado exitosamente!"

