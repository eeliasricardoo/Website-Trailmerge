name: Deploy to Cloud Run

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - production
          - staging

env:
  PROJECT_ID: galvanic-idiom-477417-j6
  REGION: us-central1
  ARTIFACT_REGISTRY_LOCATION: us-central1
  ARTIFACT_REGISTRY_REPO: trailmerge-website

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev







      - name: Determine environment and service name
        id: env
        env:
          MANUAL_ENV: ${{ github.event.inputs.environment }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ "$MANUAL_ENV" = "auto" ] || [ -z "$MANUAL_ENV" ]; then
            if [ "$BRANCH" = "staging" ]; then
              ENVIRONMENT="staging"
            elif [ "$BRANCH" = "main" ]; then
              ENVIRONMENT="production"
            else
              echo "‚ùå Error: Cannot determine environment for branch $BRANCH"
              exit 1
            fi
          else
            ENVIRONMENT="$MANUAL_ENV"
          fi
          
          if [ "$ENVIRONMENT" = "staging" ]; then
            SERVICE_NAME="trailmerge-website-staging"
          else
            SERVICE_NAME="trailmerge-website"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying to $ENVIRONMENT environment as $SERVICE_NAME"

      - name: Build and Push Docker image
        env:
          IMAGE_NAME: ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.env.outputs.service_name }}:${{ github.sha }}
        run: |
          echo "üî® Building Docker image: $IMAGE_NAME"
          
          docker build \
            --build-arg CMS_ENCRYPTION_KEY="${{ secrets.CMS_ENCRYPTION_KEY }}" \
            --build-arg ASTRO_DB_APP_TOKEN="${{ secrets.ASTRO_DB_APP_TOKEN }}" \
            -t $IMAGE_NAME \
            .
          
          echo "üì§ Pushing Docker image to Artifact Registry..."
          docker push $IMAGE_NAME
          
          echo "‚úÖ Image pushed successfully"

      - name: Deploy to Cloud Run
        env:
          SERVICE_NAME: ${{ steps.env.outputs.service_name }}
          IMAGE_NAME: ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.env.outputs.service_name }}:${{ github.sha }}
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          echo "üöÄ Deploying $SERVICE_NAME to Cloud Run..."
          
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE_NAME \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars "CMS_ENCRYPTION_KEY=${{ secrets.CMS_ENCRYPTION_KEY }}" \
            --set-env-vars "ASTRO_DB_APP_TOKEN=${{ secrets.ASTRO_DB_APP_TOKEN }}" \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8080
          
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo ""
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Service URL: $SERVICE_URL"
          echo "üìã Environment: $ENVIRONMENT"
          echo "üè∑Ô∏è  Image: $IMAGE_NAME"
