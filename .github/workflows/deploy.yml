name: Deploy to Google Cloud Storage

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        env:
          MANUAL_ENV: ${{ github.event.inputs.environment }}
          BRANCH: ${{ github.ref_name }}
        run: |
          # Determinar el entorno basado en la rama o input manual
          if [ "$MANUAL_ENV" = "auto" ] || [ -z "$MANUAL_ENV" ]; then
            # Auto-detect basado en la rama
            if [ "$BRANCH" = "staging" ]; then
              ENVIRONMENT="staging"
            elif [ "$BRANCH" = "main" ]; then
              ENVIRONMENT="production"
            else
              echo "âŒ Error: No se puede determinar el entorno para la rama $BRANCH"
              echo "Usa workflow_dispatch con un entorno especÃ­fico"
              exit 1
            fi
          else
            ENVIRONMENT="$MANUAL_ENV"
          fi
          
          if [ "$ENVIRONMENT" = "staging" ]; then
            BUCKET="staging.trailmerge.com"
            MAKE_PUBLIC=true  # PÃºblico para que el equipo pueda acceder
          else
            BUCKET="trailmerge.com"
            MAKE_PUBLIC=true  # PÃºblico para servir el sitio a travÃ©s del Load Balancer
          fi
          
          echo "ğŸš€ Deploying to $BUCKET ($ENVIRONMENT) from branch $BRANCH"
          echo "ğŸ“‹ Debug info:"
          echo "  - Branch: $BRANCH"
          echo "  - Environment: $ENVIRONMENT"
          echo "  - Bucket: $BUCKET"
          echo "  - Make Public: $MAKE_PUBLIC"
          
          # Verificar autenticaciÃ³n
          echo ""
          echo "ğŸ” Verificando autenticaciÃ³n..."
          gcloud auth list || {
            echo "âŒ Error: No hay autenticaciÃ³n activa"
            exit 1
          }
          
          # Verificar que el directorio dist existe
          echo ""
          echo "ğŸ“ Verificando directorio dist..."
          if [ ! -d "dist" ]; then
            echo "âŒ Error: El directorio dist/ no existe"
            echo "Contenido del directorio actual:"
            ls -la
            exit 1
          fi
          echo "âœ… Directorio dist/ existe"
          echo "Archivos en dist/:"
          ls -la dist/ | head -10
          
          # Verificar que gsutil estÃ¡ disponible
          echo ""
          echo "ğŸ”§ Verificando gsutil..."
          if ! command -v gsutil &> /dev/null; then
            echo "âŒ Error: gsutil no estÃ¡ disponible"
            exit 1
          fi
          echo "âœ… gsutil versiÃ³n: $(gsutil version)"
          
          # Verificar permisos del bucket
          echo ""
          echo "ğŸ“‹ Verificando acceso al bucket..."
          if ! gsutil ls gs://$BUCKET 2>&1; then
            echo ""
            echo "âŒ Error: No se puede acceder al bucket gs://$BUCKET"
            echo ""
            echo "Verifica:"
            echo "  1. Que el bucket existe: gsutil ls gs://$BUCKET"
            echo "  2. Que el service account tenga permisos Storage Admin o Storage Object Admin"
            echo "  3. Que el service account estÃ© correctamente configurado en GitHub Secrets"
            echo ""
            echo "Service account actual:"
            gcloud config get-value account 2>&1 || echo "No se pudo obtener el service account"
            exit 1
          fi
          echo "âœ… Acceso al bucket verificado"
          
          # Copiar robots.txt correcto segÃºn el entorno
          echo ""
          echo "ğŸ¤– Configurando robots.txt..."
          if [ "$ENVIRONMENT" = "staging" ]; then
            if [ -f "public/robots-staging.txt" ]; then
              cp public/robots-staging.txt dist/robots.txt
              echo "âœ… robots.txt de staging copiado"
            else
              echo "âš ï¸  robots-staging.txt no encontrado, usando el default"
            fi
          else
            if [ -f "public/robots.txt" ]; then
              cp public/robots.txt dist/robots.txt
              echo "âœ… robots.txt de production copiado"
            fi
          fi
          
          # Subir archivos
          echo ""
          echo "ğŸ“¤ Subiendo archivos..."
          if ! gsutil -m rsync -r -d dist/ gs://$BUCKET; then
            echo ""
            echo "âŒ Error al subir archivos"
            echo "Verifica los permisos del service account en el bucket"
            exit 1
          fi
          echo "âœ… Archivos subidos exitosamente"
          
          # Configurar pÃ¡gina principal
          echo ""
          echo "âš™ï¸  Configurando pÃ¡gina principal..."
          if ! gsutil web set -m index.html gs://$BUCKET; then
            echo ""
            echo "âŒ Error al configurar pÃ¡gina principal"
            exit 1
          fi
          echo "âœ… PÃ¡gina principal configurada"
          
          # Configurar permisos pÃºblicos solo para production
          if [ "$MAKE_PUBLIC" = "true" ]; then
            echo ""
            echo "ğŸŒ Configurando permisos pÃºblicos..."
            if ! gsutil iam ch allUsers:objectViewer gs://$BUCKET 2>&1; then
              echo "âš ï¸  Note: No se pudieron configurar permisos pÃºblicos (puede tener public access prevention habilitado)"
            else
              echo "âœ… Permisos pÃºblicos configurados"
            fi
          else
            echo ""
            if [ "$ENVIRONMENT" = "staging" ]; then
              echo "ğŸ”’ Staging bucket permanece privado (Load Balancer tiene acceso)"
            else
              echo "ğŸ”’ Production bucket permanece privado"
            fi
          fi
          
          echo ""
          echo "âœ… Despliegue completado exitosamente!"

