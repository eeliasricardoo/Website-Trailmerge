name: Deploy to Google Cloud Storage

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        env:
          MANUAL_ENV: ${{ github.event.inputs.environment }}
          BRANCH: ${{ github.ref_name }}
        run: |
          # Determinar el entorno basado en la rama o input manual
          if [ "$MANUAL_ENV" = "auto" ] || [ -z "$MANUAL_ENV" ]; then
            # Auto-detect basado en la rama
            if [ "$BRANCH" = "staging" ]; then
              ENVIRONMENT="staging"
            elif [ "$BRANCH" = "main" ]; then
              ENVIRONMENT="production"
            else
              echo "‚ùå Error: No se puede determinar el entorno para la rama $BRANCH"
              echo "Usa workflow_dispatch con un entorno espec√≠fico"
              exit 1
            fi
          else
            ENVIRONMENT="$MANUAL_ENV"
          fi
          
          if [ "$ENVIRONMENT" = "staging" ]; then
            BUCKET="staging.trailmerge.com"
            MAKE_PUBLIC=false
          else
            BUCKET="trailmerge.com"
            MAKE_PUBLIC=true
          fi
          
          echo "üöÄ Deploying to $BUCKET ($ENVIRONMENT) from branch $BRANCH"
          gsutil -m rsync -r -d dist/ gs://$BUCKET
          gsutil web set -m index.html gs://$BUCKET
          if [ "$MAKE_PUBLIC" = "true" ]; then
            gsutil iam ch allUsers:objectViewer gs://$BUCKET || echo "Note: Bucket may have public access prevention enabled"
          else
            echo "üîí Staging bucket remains private (authentication required)"
          fi

